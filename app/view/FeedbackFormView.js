/*
 * File: app/view/FeedbackFormView.js
 *
 * This file was generated by Sencha Architect version 3.2.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Sencha Touch 2.4.x library, under independent license.
 * License of Sencha Architect does not include license for Sencha Touch 2.4.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('MEC_App.view.FeedbackFormView', {
    extend: 'Ext.form.Panel',
    alias: 'widget.FeedbackFormView',

    requires: [
        'Ext.Label',
        'Ext.form.FieldSet',
        'Ext.field.Email',
        'Ext.field.Number',
        'Ext.field.TextArea',
        'Ext.Panel',
        'Ext.Img',
        'Ext.Button',
        'Ext.device.Camera',
        'Ext.device.Notification',
        'MEC_App.controller.DeviceController'
    ],

    config: {
        cls: 'complaint-view',
        itemId: 'FeedbackFormView',
        layout: 'vbox',
        enableSubmissionForm: false,
        items: [
            {
                xtype: 'label',
                cls: 'inners-title',
                html: 'مقترحات',
                itemId: 'lblTitle'
            },
            {
                xtype: 'fieldset',
                flex: 1,
                itemId: 'FeedbackForm',
                scrollable: {
                    direction: 'vertical',
                    directionLock: true
                },
                items: [
                    {
                        xtype: 'textfield',
                        itemId: 'txtFullName',
                        label: 'الاسم بالكامل',
                        labelWidth: '40%',
                        name: 'fullName',
                        required: true,
                        placeHolder: 'الاسم بالكامل'
                    },
                    {
                        xtype: 'emailfield',
                        itemId: 'txtEmail',
                        label: 'البريد الالكتروني',
                        labelWidth: '40%',
                        name: 'email',
                        placeHolder: 'البريد الالكتروني'
                    },
                    {
                        xtype: 'numberfield',
                        itemId: 'txtMobile',
                        component: {
                            type: 'tel'
                        },
                        label: 'رقم الهاتف',
                        labelWidth: '40%',
                        name: 'mobile',
                        required: true,
                        placeHolder: 'رقم الهاتف'
                    },
                    {
                        xtype: 'textareafield',
                        itemId: 'txtComment',
                        label: 'نص المقترح',
                        labelWidth: '40%',
                        name: 'suggestion',
                        required: true,
                        placeHolder: 'نص المقترح'
                    },
                    {
                        xtype: 'label',
                        html: 'ارفق صورة',
                        id: 'lblAttachImage1',
                        itemId: 'lblAttachImage1'
                    },
                    {
                        xtype: 'panel',
                        layout: 'hbox',
                        items: [
                            {
                                xtype: 'image',
                                flex: 1,
                                height: 120,
                                itemId: 'img1',
                                src: 'resources/images/attach-default.png'
                            },
                            {
                                xtype: 'image',
                                flex: 1,
                                itemId: 'img2',
                                src: 'resources/images/attach-default.png'
                            }
                        ]
                    },
                    {
                        xtype: 'panel',
                        layout: 'hbox',
                        items: [
                            {
                                xtype: 'image',
                                flex: 1,
                                height: 120,
                                itemId: 'img3',
                                src: 'resources/images/attach-default.png'
                            },
                            {
                                xtype: 'image',
                                flex: 1,
                                height: 120,
                                itemId: 'img4',
                                width: 200,
                                src: 'resources/images/attach-default.png'
                            }
                        ]
                    },
                    {
                        xtype: 'button',
                        handler: function(button, e) {

                            var frm = button.up('FeedbackFormView');



                            //alert(frm.getValues().shopName);
                            var formData =frm.getValues(),
                                ereg = /^\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/,
                                testResult = ereg.test(formData.email),
                                err='';
                            console.log(formData);



                            if(formData.fullName===''){

                                err+=Ext.Localization.GetMessage('errFullName');
                            }

                            if(formData.email !=='' && !testResult){
                                err+=Ext.Localization.GetMessage('errMail');
                            }

                            if(formData.mobile === null){
                                err+=Ext.Localization.GetMessage('errMobile');
                            }

                            if(formData.suggestion===''){

                                err+=Ext.Localization.GetMessage('errSuggestion');
                            }



                            if(err.length>0){

                                Ext.device.Notification.show({
                                    title: Ext.Localization.GetMessage('Error'),
                                    buttons:[Ext.Localization.GetMessage('OK')],
                                    message: err
                                });
                            }else{






                                // generate Complaint Key
                                var ran = Math.floor(Math.random() * 1000000000);


                                //upload files, in the last file send the email
                                var files = [];



                                var img1 = frm.down('#img1');
                                if(img1.getSrc()!=='resources/images/attach-default.png')
                                files.push(img1.getSrc());


                                var img2 = frm.down('#img2');
                                if(img2.getSrc()!=='resources/images/attach-default.png')
                                files.push(img2.getSrc());



                                var img3 = frm.down('#img3');
                                if(img3.getSrc()!=='resources/images/attach-default.png')
                                files.push(img3.getSrc());


                                var img4 = frm.down('#img4');
                                if(img4.getSrc()!=='resources/images/attach-default.png')
                                files.push(img4.getSrc());



                                Ext.AnimationHelper.ShowLoading();


                                var uploadUrl = Ext.Global.GetConfig('CMSWSUrl').replace('/CMS/api','/FeedBack/upload.ashx');


                                if(files.length>0)
                                {

                                    for (i = 0; i < files.length; i++) {

                                        var isLast = false;
                                        if(i===files.length-1) isLast = true;
                                        Ext.DeviceController.UploadImage(ran,files[i],isLast,formData,uploadUrl);

                                    }

                                }else{

                                    Ext.DeviceController.UploadImage(ran,img1.getSrc(),true,formData,uploadUrl);

                                }








                                Ext.defer(function(){
                                    Ext.AnimationHelper.HideLoading();

                                    Ext.device.Notification.show({
                                        title: Ext.Localization.GetMessage('Message'),
                                        buttons:[Ext.Localization.GetMessage('OK')],
                                        message: Ext.Localization.GetMessage('ComplaintsConfirmation'),
                                        callback: function(button) {

                                            //return user to home page

                                            Ext.Viewport.getActiveItem().reset();

                                        }
                                    });


                                },2000);











                            }
                        },
                        cls: 'btn-send',
                        id: 'btnSubmitComplaint1',
                        itemId: 'btnSubmitComplaint1',
                        text: 'إرسال'
                    }
                ]
            }
        ],
        listeners: [
            {
                fn: 'onImg1Tap',
                event: 'tap',
                delegate: '#img1'
            },
            {
                fn: 'onImg2Tap',
                event: 'tap',
                delegate: '#img2'
            },
            {
                fn: 'onImg3Tap',
                event: 'tap',
                delegate: '#img3'
            },
            {
                fn: 'onImg4Tap',
                event: 'tap',
                delegate: '#img4'
            }
        ]
    },

    onImg1Tap: function(image, e, eOpts) {
                //custom class MEC_App.controller.DeviceController
                Ext.DeviceController.CaptureImage(image);


    },

    onImg2Tap: function(image, e, eOpts) {

                //custom class MEC_App.controller.DeviceController
                Ext.DeviceController.CaptureImage(image);

    },

    onImg3Tap: function(image, e, eOpts) {

                //custom class MEC_App.controller.DeviceController
                Ext.DeviceController.CaptureImage(image);

    },

    onImg4Tap: function(image, e, eOpts) {

                //custom class MEC_App.controller.DeviceController
                Ext.DeviceController.CaptureImage(image);

    },

    initialize: function() {
        this.callParent();

        Ext.Localization.LoadLocalization();

        Ext.Localization.LocalizeView(this);

    }

});